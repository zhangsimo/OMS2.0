<template>
  <div class="content-oper content-oper-flex">
    <section class="oper-box">
      <div class="oper-top flex">
        <div class="db mt20">
          <span>门店：</span>
          <Input v-model="orgName" readonly class="w100"/>
          <Button class="ml10" @click="write">核销对账单</Button>
        </div>
      </div>
      <div class="ml20 mb10">
        <Row>
          <Col span="6">
            <span>对账单勾选金额</span>
          </Col>
          <Col span="3">
            <span>{{currentAccount.actualCollectionOrPayment}}</span>
          </Col>
          <Col span="6">
            <span>认领款勾选金额</span>
          </Col>
          <Col span="3">
            <span>{{claimedAmt}}</span>
          </Col>
          <Col span="2">
            <span>差异</span>
          </Col>
          <Col span="2">
            <span>{{difference}}</span>
          </Col>
        </Row>
      </div>
    </section>
    <section class="con-box">
      <div class="inner-box">
        <Split v-model="split1">
          <div slot="left">
            <h4 class="mb10 p5 pl10" style="background:#F2F2F2">未核销对账单</h4>
<!--            <span>快速查询：</span>-->
            <quickDate class="w60 mr10" ref="quickDate" @quickDate="quickDate"></quickDate>
            <span>申请日期：</span>
            <Date-picker
              format="yyyy-MM-dd"
              :value="value"
              @on-change="changedate"
              type="daterange"
              placeholder="选择日期"
              class="w200 mr10"
            ></Date-picker>
            <span>分店名称：</span>
            <Select v-model="model1" filterable class="w150 mr10" :disabled="selectShopList">
              <Option
                v-for="item in orgList"
                :value="item.id"
                :key="item.id"
              >{{ item.name }}
              </Option>
            </Select>
            <span>往来单位：</span>
            <Select
              v-model="companyIdNo"
              class="w100 mr10"
              clearable
              filterable
              remote
              :loading="remoteloading"
              :remote-method="getOne"
            >
              <Option v-for="item in company" :value="item.value" :key="item.value">{{ item.label }}</Option>
            </Select>
            <span class="ml10">收付类型：</span>
            <Select v-model="paymentId" class="w100" filterable>
              <Option
                v-for="item in paymentList"
                :value="item.value"
                :key="item.value"
              >{{ item.label }}
              </Option>
            </Select>
            <span class="ml10">金额：</span>
            <InputNumber v-model="amtNo" class="w50"/>
            <button class="ivu-btn ivu-btn-default ml10 mt10" type="button" @click="queryNoWrite">
              <i class="iconfont iconchaxunicon"></i>
              <span>查询</span>
            </button>
            <Table
              border
              class="mt10"
              :columns="accountNoWrite"
              :data="accountNoWriteData"
              max-height="400"
              highlight-row
              @on-current-change="accountNoWriteChange"
            ></Table>
            <Page
              show-sizer
              show-total
              show-elevator
              class="mt10 tr mr10"
              size="small"
              :total="accountPage.total"
              :current="accountPage.page"
              :page-size="accountPage.size"
              @on-change="pageChangeNo"
              @on-page-size-change="sizeChangeNo"
            />
          </div>
          <div slot="right" style="height:100%">
            <Split v-model="split2" mode="vertical">
              <div slot="top" class="pl10">
                <h4 class="mb10 p5 pl10" style="background:#F2F2F2">本店待认领款</h4>
<!--                <span class="pl10">快速查询：</span>-->
                <quickDate class="w80 mr10" ref="quickDate2" @quickDate="quickDate2"></quickDate>
                <span>申请日期：</span>
                <Date-picker
                  format="yyyy-MM-dd"
                  :value="value2"
                  @on-change="changedate2"
                  type="daterange"
                  placeholder="选择日期"
                  class="w200 mr10"
                ></Date-picker>
                <span>分店名称：</span>
                <Select v-model="model2" filterable class="w150 mr10" :disabled="selectShopList">
                  <Option
                    v-for="item in orgList"
                    :value="item.id"
                    :key="item.id"
                  >{{ item.name }}
                  </Option>
                </Select>
                <span class="ml10">往来单位：</span>
                <Select
                  v-model="companyIdClaim"
                  class="w100"
                  clearable
                  filterable
                  remote
                  :loading="remoteloading2"
                  :remote-method="getOne2"
                >
                  <Option v-for="item in company2" :value="item.value" :key="item.value">{{ item.label }}</Option>
                </Select>
                <span class="ml10">金额：</span>
                <InputNumber v-model="amtClaim" class="w50"/>
                <span class="ml10">对方户名：</span>
                <Input v-model="bankNameOClaim" class="w100"/>
                <button class="ivu-btn ivu-btn-default ml10" type="button" @click="queryClaimed">
                  <i class="iconfont iconchaxunicon"></i>
                  <span>查询</span>
                </button>
                <br/>
                <Button class="mt10 ml10" v-has="'revoke'" @click="distributionDelete">撤销分配</Button>
                <Button class="mt10 ml10" v-has="'now'" @click="openSubjecMoadl">转当期损益</Button>
                <Button class="mt10 ml10" @click="openOtherCollectionClaims('预收款认领')">预收款认领</Button>
                <Button class="mt10 ml10" @click="openOtherPaymentClaims('预付款认领')">预付款认领</Button>
                <Button class="mt10 ml10" @click="openOtherCollectionClaims('其他收款认领')">其他收款认领</Button>
                <Button class="mt10 ml10" @click="openOtherPaymentClaims('其他付款认领')">其他付款认领</Button>
                <Button class="mt10 ml10" @click="openAccrued">转应收应付</Button>
                <claim ref="claim"/>
              </div>
              <div slot="bottom" class="pl10">
                <h4 class="mb10 p5 pl10" style="background:#F2F2F2">连锁待分配款项</h4>
<!--                <span class="pl10 mr10">快速查询：</span>-->
                <quickDate class="w60 mr10" ref="quickDate3" @quickDate="quickDate3"></quickDate>
                <span>发生日期：</span>
                <Date-picker
                  format="yyyy-MM-dd"
                  :value="value3"
                  @on-change="changedate3"
                  type="daterange"
                  placeholder="选择日期"
                  class="w200 mr10"
                ></Date-picker>
                <span class="ml10">区域：</span>
                <Select v-model="areaId" class="w100" filterable :disabled="selectShopList">
                  <Option
                    v-for="item in areaList"
                    :value="item.value"
                    :key="item.value"
                  >{{ item.label }}
                  </Option>
                </Select>
                <span class="ml10">门店：</span>
                <Select v-model="orgId" class="w150" filterable :disabled="selectShopList">
                  <Option v-for="item in orgList" :value="item.id" :key="item.id">{{ item.name }}</Option>
                </Select>
                <span class="ml10">金额：</span>
                <InputNumber v-model="amtDis" class="w50"/>
                <span class="ml10">对方户名：</span>
                <Input v-model="bankNameODis" class="w100"/>
                <button
                  class="ivu-btn ivu-btn-default ml10"
                  type="button"
                  @click="queryDistribution"
                >
                  <i class="iconfont iconchaxunicon"></i>
                  <span>查询</span>
                </button>
                <button
                  class="ivu-btn ivu-btn-default ml10 mt10"
                  type="button"
                  @click="distributionShop"
                >分配至本店
                </button>
                <Table
                  border
                  class="mt10"
                  :columns="distribution"
                  :data="distributionData"
                  max-height="400"
                  @on-selection-change="distributionSelection"
                ></Table>
                <Page
                  show-sizer
                  show-total
                  show-elevator
                  class="mt10 tr"
                  size="small"
                  :total="distributionPage.total"
                  :current="distributionPage.page"
                  :page-size="distributionPage.size"
                  @on-change="pageChange"
                  @on-page-size-change="sizeChange"
                />
              </div>
            </Split>
            <!-- 转当期损益 -->
            <subject ref="subjecModal" :clime="claimedSubjectList"></subject>
            <!-- 预收款认领 collectionClaims-->
            <!-- 预付款认领 paymentClaim-->
            <!-- 其他收款认领 otherCollectionClaims  预收款认领 collectionClaims-->
            <otherCollectionClaims ref="otherCollectionClaims" :accrued="claimedSubjectList"></otherCollectionClaims>
            <!-- 其他付款认领 otherPaymentClaim-->
            <otherPaymentClaim ref="otherPaymentClaim" :accrued="claimedSubjectList"></otherPaymentClaim>
            <!-- 转应收应付 accrued-->
            <accrued ref="accrued" :accrued="claimedSubjectList"></accrued>
          </div>
        </Split>
      </div>
    </section>
    <advance ref="advance"/>
    <expenditure ref="expenditure" :title="title"/>
    <settlement ref="settlement"/>
    <chargeAdvance ref="chargeAdvance"/>
  </div>
</template>
<script>
  import {getbayer} from "@/api/AlotManagement/threeSupplier";
  import {getSupplierList} from "_api/purchasing/purchasePlan";
  import advance from "./components/Advance";
  import chargeAdvance from "./components/chargeAdvance";
  import expenditure from "./components/expenditure";
  import settlement from "./components/settlement";
  import claim from "../../components/claimed";
  import {getDataDictionaryTable} from "@/api/system/dataDictionary/dataDictionaryApi";
  import {
    accountNoSelete,
    distributionSelete,
    claimedFund,
    distributionShop,
    distributionRevoke
  } from "_api/settlementManagement/fundsManagement/claimWrite.js";
  import {are} from "@/api/settlementManagement/fundsManagement/capitalChain";
  import {goshop} from "@/api/settlementManagement/shopList";
  import {findGuest} from "_api/settlementManagement/advanceCollection.js";
  import {creat} from "../../components";
  import bus from "../../bill/Popup/Bus";
  import subject from "./components/Subject";
  import accrued from "./components/accrued";
  import otherCollectionClaims from "./components/otherCollectionClaims";
  import otherPaymentClaim from "@/view/settlementManagement/fundsManagement/claimWrite/components/otherPaymentClaim";
  import quickDate from "@/components/getDate/dateget_bill.vue";
  import moment from "moment";

  export default {
    name: "claimWrite",
    components: {
      advance,
      expenditure,
      settlement,
      claim,
      chargeAdvance,
      subject,
      accrued,
      otherCollectionClaims,
      otherPaymentClaim,
      quickDate
    },
    data() {
      return {
        model1: "",//未核销对账单 查询分店绑定model
        value: [],//未核销对账单 查询快速
        // applyDate:"",//未核销对账单 查询申请日期value
        model2: "",//本店待认领款 查询分店绑定model
        value2: [],//本店待认领款 快速查询
        // applyDate2:"",//本店待认领款 查询申请日期value
        // model3:[],//连锁待分配款项 查询分店绑定model
        value3: [],//连锁待分配款项 快速查询
        // applyDate3:"",//连锁待分配款项 查询申请日期
        remoteloading: false,
        remoteloading2: false,
        title: "预付款认领", //弹框标题
        split1: 0.4, //左右面板分割
        split2: 0.52, //上下面板分割
        orgName: "", //门店
        companyIdNo: "", //未核销往来单位
        companyIdClaim: "", //待认领往来单位
        company: [], //往来单位下拉框
        company2: [], //往来单位下拉框
        orgId: "", //门店  连锁待分配款项
        orgList: [{id: "0", name: "全部"}], //分店名称
        claimedSubjectList: [], //获取到点击到的本店认领数据
        areaId: 0, //区域
        areaList: [{value: 0, label: "全部"}], //区域
        bankNameOClaim: "", //对方户名
        bankNameODis: "", //对方户名
        paymentId: "YJDZ", //收付类型
        paymentList: [], //收付类型下拉框
        amtNo: null, //金额
        amtClaim: null, //金额
        amtDis: null, //金额
        accountPage: {
          page: 1,
          total: 0,
          size: 10
        }, //未核销分页
        currentAccount: {}, //未核销选中的数据
        accountNoWrite: [
          {
            title: "序号",
            type: "index",
            align: "center",
            width: 40
          },
          {
            title: "门店名称",
            key: "orgName",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.orgName
                  }
                }, params.row.orgName)
              ])
            }
          },
          {
            title: "对账单号",
            key: "accountNo",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.accountNo
                  }
                }, params.row.accountNo)
              ])
            }
          },
          {
            title: "往来单位",
            key: "guestName",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.guestName
                  }
                }, params.row.guestName)
              ])
            }
          },
          {
            title: "发生日期",
            key: "createTime",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.createTime
                  }
                }, params.row.createTime)
              ])
            }
          },
          {
            title: "收付类型",
            key: "receivePaymentTypeName",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.receivePaymentTypeName
                  }
                }, params.row.receivePaymentTypeName)
              ])
            }
          },
          {
            title: "实际收款/付款",
            key: "actualCollectionOrPayment",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.actualCollectionOrPayment
                  }
                }, params.row.actualCollectionOrPayment)
              ])
            }
          },
          {
            title: "已收/已付金额",
            key: "amountReceivedOrPaid",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.amountReceivedOrPaid
                  }
                }, params.row.amountReceivedOrPaid)
              ])
            }
          },
          {
            title: "未收/未付金额",
            key: "amountNoCharOffOrUnpaid",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.amountNoCharOffOrUnpaid
                  }
                }, params.row.amountNoCharOffOrUnpaid)
              ])
            }
          }
        ], //未核销对账单表格数据
        accountNoWriteData: [], //未核销对账单表格数据
        distribution: [
          {
            title: "选择",
            type: "selection",
            align: "center",
            width: 40
          },
          {
            title: "序号",
            type: "index",
            align: "center",
            width: 40
          },
          {
            title: "所属区域",
            key: "area",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.area
                  }
                }, params.row.area)
              ])
            }
          },
          {
            title: "所属门店",
            key: "shopName",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.shopName
                  }
                }, params.row.shopName)
              ])
            }
          },
          {
            title: "所属店号",
            key: "shopCode",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.shopCode
                  }
                }, params.row.shopCode)
              ])
            }
          },
          {
            title: "账户",
            key: "accountName",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.accountName
                  }
                }, params.row.accountName)
              ])
            }
          },
          {
            title: "账号",
            key: "accountCode",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.accountCode
                  }
                }, params.row.accountCode)
              ])
            }
          },
          {
            title: "开户行",
            key: "bankName",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.bankName
                  }
                }, params.row.bankName)
              ])
            }
          },
          {
            title: "对应科目",
            key: "mateAccountName",
            align: "center",
            minWidth: 100,
          },
          {
            title: "发生日期",
            key: "createTime",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.createTime
                  }
                }, params.row.createTime)
              ])
            }
          },
          {
            title: "收入金额",
            key: "incomeMoney",
            align: "center",
            minWidth: 100,
          },
          {
            title: "支出金额",
            key: "paidMoney",
            align: "center",
            minWidth: 100,
          },
          {
            title: "对方户名",
            key: "reciprocalAccountName",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.reciprocalAccountName
                  }
                }, params.row.reciprocalAccountName)
              ])
            }
          },
          {
            title: "交易备注",
            key: "tradingNote",
            align: "center",
            minWidth: 100,
            render: (h, params) => {
              return h('div', [
                h('span', {
                  style: {
                    display: 'inline-block',
                    width: '100%',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  },
                  domProps: {
                    title: params.row.tradingNote
                  }
                }, params.row.tradingNote)
              ])
            }
          }
        ], //连锁待分配款项
        distributionData: [], //连锁待分配款项列表
        distributionPage: {
          page: 1,
          total: 0,
          size: 10
        }, //连锁待分配款项分页
        currentDistribution: [], //本店待认领款选中的数据
        claimedAmt: null, //认领款勾选金额
        difference: null //差异
      };
    },
    async mounted() {
      // this.getOne();
      //收付类型数据字典
      getDataDictionaryTable({dictCode: "RECEIVE_PAYMENT_TYPE"}).then(res => {
        res.data.map(item => {
          this.paymentList.push({
            value: item.itemCode,
            label: item.itemName
          });
        });
      });
      let arr = await creat([], this.$store);
      this.orgName = arr[3];
      this.$nextTick(() => {
        this.orgId = arr[1];
        this.model1 = arr[1];
        this.model2=arr[1];
        this.queryNoWrite()
        this.claimedList();
        this.distributionList();
      })
      this.getAllAre();
      this.getShop();
      if (Object.keys(this.$route.params).length !== 0) {
        this.$route.params.data.receivePaymentTypeName = this.$route.params.data.paymentTypeName;
        this.$route.params.data.actualCollectionOrPayment = this.$route.params.data.receiptPayment;
        if (this.$route.params.data.billingTypeName === "付款") {
          this.$route.params.data.amountReceivedOrPaid = this.$route.params.data.amountPaid;
          this.$route.params.data.amountNoCharOffOrUnpaid = this.$route.params.data.unpaidAmount;
        } else {
          this.$route.params.data.amountReceivedOrPaid = this.$route.params.data.amountReceived;
          this.$route.params.data.amountNoCharOffOrUnpaid = this.$route.params.data.noCharOffAmt;
        }
        this.accountNoWriteData.push(this.$route.params.data);
      }
    },
    computed: {
      selectShopList() {
        return  this.$store.state.user.userData.currentCompany ? this.$store.state.user.userData.currentCompany.shortName ? this.$store.state.user.userData.currentCompany.shortName:'请选择分店':"请选择分店"
      }
    },
    methods: {
      // 快速查询 未核销对账单
      quickDate(data) {
        this.value = data ? data : ["", ""];
        // this.queryNoWrite();
      },
      // 快速查询 本店待认领款
      quickDate2(data) {
        this.value2 = data ? data : ["", ""];
        // this.queryClaimed();
      },
      // 快速查询 连锁待分配款项
      quickDate3(data) {
        this.value3 = data ? data : ["", ""];
        // this.queryDistribution();
      },
      // 选择日期 未核销对账单
      changedate(daterange) {
        this.value = daterange;
        this.queryNoWrite()
      },
      // 选择日期 未核销对账单
      changedate2(daterange) {
        this.value2 = daterange;
        this.queryClaimed()
      },
      // 选择日期 连锁待分配款项
      changedate3(daterange) {
        this.value3 = daterange;
        this.queryDistribution()
      },
      //获取门店
      async getShop() {
        let data = {};
        let res = await goshop(data);
        if (res.code === 0) {
          this.orgList = [...this.orgList, ...res.data]
          if (this.areaList.length > 0) {
            this.areaList.map(item => {
              this.orgList.map(item2 => {
                if (item.parentId == item2.supplierTypeFirst && item.value == item2.supplierTypeSecond) {
                  this.areaId = item.value
                }
              })
            })
          }
        }
      },
      // 往来单位选择
      async getOne(query) {
        this.company = [];
        if (query != "") {
          this.remoteloading = true;
          findGuest({fullName: query, size: 20}).then(res => {
            if (res.code === 0) {
              this.company = [];
              res.data.content.map(item => {
                this.company.push({
                  value: item.id,
                  label: item.fullName
                });
              });
              this.remoteloading = false;
            }
          });
        } else {
          this.company = [];
        }
      },
      async getOne2(query) {
        this.company2 = [];
        if (query != "") {
          this.remoteloading2 = true;
          findGuest({fullName: query, size: 20}).then(res => {
            if (res.code === 0) {
              this.company2 = [];
              res.data.content.map(item => {
                this.company2.push({
                  value: item.id,
                  label: item.fullName
                });
              });

              this.remoteloading2 = false;
            }
          });
        } else {
          this.company2 = [];
        }
      },
      //核销对账单
      write() {
        if (Object.keys(this.currentAccount).length === 0)
          return this.$message.error("请选择一条未核销对账单");
        if (this.$refs.claim.currentClaimed.length === 0)
          return this.$message.error("至少选择一条本店待认领款");
        this.$refs.settlement.Settlement = true;
      },

      //打开选择会计科目
      openSubjecMoadl() {
        if (this.$refs.claim.currentClaimed.length == 0) {
          this.$message.error("请先选择数据");
        } else if (this.$refs.claim.currentClaimed.length > 1) {
          this.$message.error("只能为一条数据进行当前转益");
        } else {
          this.claimedSubjectList = this.$refs.claim.currentClaimed;
          this.$refs.subjecModal.open();
        }
      },
      // 打开应收应付弹框
      openAccrued() {
        if (this.$refs.claim.currentClaimed.length == 0) {
          this.$message.error("请先选择数据");
        } else if (this.$refs.claim.currentClaimed.length > 1) {
          this.$message.error("只能为一条数据进行转应收应付操作");
        } else {
          this.claimedSubjectList = this.$refs.claim.currentClaimed;
          if (this.claimedSubjectList[0].incomeMoney > 0) {
            this.$refs.accrued.bool = false;
          } else {
            this.$refs.accrued.bool = true;
          }
          this.claimedSubjectList.map(item => {
            item.balanceMoney = Math.abs(item.paidMoney || item.incomeMoney)
          })
          this.$refs.accrued.open();
        }
      },
      // 打开   预收款认领/其他收款认领   弹框
      openOtherCollectionClaims(claimTit) {
        if (this.$refs.claim.currentClaimed.length == 0) {
          this.$message.error("请先选择数据");
        } else if (this.$refs.claim.currentClaimed.length > 1) {
          this.$message.error("只能为一条数据进行转应收应付操作");
        } else {
          this.claimedSubjectList = this.$refs.claim.currentClaimed;
          this.$refs.otherCollectionClaims.claimTit = claimTit;
          if (this.claimedSubjectList[0].incomeMoney > 0) {
            this.$refs.otherCollectionClaims.open();
          } else {
            claimTit = "预收款认领"
              ? this.$message.error("预收款认领不能选择支出类资金")
              : this.$message.error("其他收款认领不能选择支出类资金");
          }
        }
      },
      // 打开   预付款认领/其他付款认领   弹框
      openOtherPaymentClaims(claimTit) {
        if (this.$refs.claim.currentClaimed.length == 0) {
          this.$message.error("请先选择数据");
        } else if (this.$refs.claim.currentClaimed.length > 1) {
          this.$message.error("只能为一条数据进行转应收应付操作");
        } else {
          // this.claimedSubjectList.map(item=>{
          //   item.paidMoney=JSON.stringify(item.paidMoney).split("-")[1]
          // })
          this.claimedSubjectList = this.$refs.claim.currentClaimed;
          this.$refs.otherPaymentClaim.claimTit = claimTit;
          if (this.claimedSubjectList[0].paidMoney < 0) {
            this.$refs.otherPaymentClaim.open();
          } else {
            claimTit == "预付款认领"
              ? this.$message.error("预付款认领不能选择收入类资金")
              : this.$message.error("其他付款认领不能选择收入类资金");
          }
        }
      },
      //未核销对账单查询
      queryNoWrite() {
        this.noWrite();
      },
      // 本店待认领款查询
      queryClaimed() {
        this.claimedList();
      },
      //连锁待分配款项
      queryDistribution() {
        this.distributionList();
      },
      //撤销分配
      distributionDelete() {
        if (this.$refs.claim.currentClaimed.length !== 0) {
          this.$Modal.confirm({
            title: "是否撤回分配",
            onOk: () => {
              let arr = [];
              this.$refs.claim.currentClaimed.map(item => {
                arr.push(item.id);
              });
              distributionRevoke(arr).then(res => {
                if (res.code === 0) {
                  this.$message.success("撤销成功");
                  this.claimedList();
                  this.distributionList();
                }
              });
            },
            onCancel: () => {
            }
          });
        } else {
          this.$message.error("请先选择数据");
        }
      },
      //预收款认领/预收款支出认领
      clim(type) {
        if (
          this.$refs.claim.currentClaimed.length !== 0 &&
          this.$refs.claim.currentClaimed[0].incomeMoney
        ) {
          if (type) {
            this.$refs.chargeAdvance.modal = true;
          } else {
            this.$refs.advance.modal = true;
          }
        } else {
          this.$message.error("至少选择一条数据且是收款数据");
        }
      },
      //预付款认领/预付款收回认领
      expenditureClim(type) {
        if (
          this.$refs.claim.currentClaimed.length !== 0 &&
          this.$refs.claim.currentClaimed[0].paidMoney
        ) {
          if (type) {
            this.title = "预付款收回认领";
          } else {
            this.title = "预付款认领";
          }
          this.$refs.expenditure.modal = true;
        } else {
          this.$message.error("至少选择一条数据且是付款数据");
        }
      },
      //分配至本店
      distributionShop() {
        if (this.currentDistribution.length !== 0) {
          let obj = [];
          this.currentDistribution.map(item => {
            obj.push({id: item.id});
          });
          distributionShop(obj).then(res => {
            if (res.code === 0) {
              this.$message.success("分配成功");
              this.distributionList();
              this.claimedList();
            }
          });
        } else {
          this.$message.error("请先选择数据");
        }
      },
      //未核销选中的数据
      accountNoWriteChange(currentRow) {
        this.currentAccount = currentRow;
        this.difference = currentRow.actualCollectionOrPayment - this.claimedAmt;
      },
      //连锁待分配款项选中的数据
      distributionSelection(selection) {
        this.currentDistribution = selection;
      },
      //未核销对账单查询接口
      noWrite() {
        let obj = {
          amount: this.amtNo,
          guestId: this.companyIdNo,
          receivePaymentType: this.paymentId,
          page: this.accountPage.page - 1,
          size: this.accountPage.size,

          orgId: this.model1,//分店名称
          startDate: this.value[0]
            ? moment(this.value[0]).format("YYYY-MM-DD HH:mm:ss")
            : "",    //开始时间参数
          endDate: this.value[1]
            ? moment(this.value[1]).format("YYYY-MM-DD HH:mm:ss")
            : "",     //结束时间参数
          // createTime:this.applyDate //日期查询时间发生日期
        };
        accountNoSelete(obj).then(res => {
          if (res.code === 0) {
            this.accountNoWriteData = res.data.content;
            this.accountPage.total = res.data.totalElements;
          }
        });
      },
      //本店待认领款查询接口
      claimedList() {
        let obj = {
          amount: this.amtClaim,
          suppliers: this.companyIdClaim,
          reciprocalAccountName: this.bankNameOClaim,
          page: this.$refs.claim.claimedPage.page - 1,
          size: this.$refs.claim.claimedPage.size,

          orgId: this.model2,//分店
          startDate: this.value2[0]
            ? moment(this.value2[0]).format("YYYY-MM-DD HH:mm:ss")
            : "",    //开始时间参数
          endDate: this.value2[1]
            ? moment(this.value2[1]).format("YYYY-MM-DD HH:mm:ss")
            : "",     //结束时间参数
          // createTime:this.applyDate2 //日期查询时间发生日期
        };
        claimedFund(obj).then(res => {
          if (res.code === 0) {
            this.$refs.claim.claimedData = res.data.content;
            this.$refs.claim.claimedPage.total = res.data.totalElements;
          }
        });
      },
      //连锁待分配款项查询接口
      distributionList() {
        let obj = {
          area: this.areaId,
          orgId: this.orgId,
          amount: this.amtDis,
          reciprocalAccountName: this.bankNameODis,
          page: this.distributionPage.page - 1,
          size: this.distributionPage.size,

          startDate: this.value3[0]
            ? moment(this.value3[0]).format("YYYY-MM-DD HH:mm:ss")
            : "",    //开始时间参数
          endDate: this.value3[1]
            ? moment(this.value3[1]).format("YYYY-MM-DD HH:mm:ss")
            : "",     //结束时间参数
          // createTime:this.applyDate3 //日期查询时间发生日期
        };
        distributionSelete(obj).then(res => {
          if (res.code === 0) {
            this.distributionData = res.data.content;
            this.distributionPage.total = res.data.totalElements;
          }
        });
      },
      //获取全部地址
      async getAllAre() {
        let res = await are();
        if (res.code === 0) {
          res.data.map(item => {
            this.areaList.push({
              value: item.id,
              label: item.companyName,
              parentId: item.parentId
            });
          });
        }
      },
      //未核销对账单页码改变
      pageChangeNo(val) {
        this.accountPage.page = val;
        this.noWrite();
      },
      //未核销对账单每页条数改变
      sizeChangeNo(val) {
        this.accountPage.page = 1;
        this.accountPage.size = val;
        this.noWrite();
      },
      // 连锁待分配款项页码
      pageChange(val) {
        this.distributionPage.page = val;
        this.distributionList();
      },
      // 连锁待分配款项每页条数
      sizeChange(val) {
        this.distributionPage.page = 1;
        this.distributionPage.size = val;
        this.distributionList();
      }
    }
  };
</script>
<style>
  .top-pane,
  .bottom-pane {
    overflow: auto;
  }
</style>

<template>
  <div>
    <div class="orderList">
      <h5>销售订单列表</h5>
    </div>
    <div class="orderCenter">
      <vxe-table
        ref="currentRowTable"
        border
        align="center"
        size="mini"
        @current-change="clickOnesList"
        highlight-hover-row
        highlight-current-row
        style="width: 1000px"
        height="593"
        :data="tableData"
      >
        <vxe-table-column type="index" title="序号" width="60"></vxe-table-column>
        <vxe-table-column field="billStatusId" title="状态">
          <template v-slot="{ row }">
            <span>{{row.billStatusId.name}}</span>
          </template>
        </vxe-table-column>
        <vxe-table-column field="guestName" title="客户"></vxe-table-column>
        <vxe-table-column field="createTime" title="创建日期"></vxe-table-column>
        <vxe-table-column field="orderMan" title="销售员"></vxe-table-column>
        <vxe-table-column field="serviceId" title="销售订单单号"></vxe-table-column>
        <vxe-table-column field="printTimes" title="打印次数"></vxe-table-column>
        <vxe-table-column field="auditor" title="提交人"></vxe-table-column>
        <vxe-table-column field="auditDate" title="提交日期"></vxe-table-column>
        <vxe-table-column field="createUname" title="创建人"></vxe-table-column>
      </vxe-table>
    </div>
    <Page
      :total="page.total"
      :page-size="page.size"
      size="small"
      :current="page.num"
      show-sizer
      show-total
      class-name="page-con"
      @on-change="selectNum"
      @on-page-size-change="selectPage"
      :page-size-opts="[20, 50, 100, 200]"
      class="mr10"
    ></Page>
  </div>
</template>

<script>
import { getLeftList } from "@/api/salesManagment/salesOrder";

export default {
  name: "OrderLeft",
  props: {
    queryTime: "", //时间查询
    orderType: "", //状态查询
    changeLeftList: "" //改变list
  },
  data() {
    return {
      PtRow:{
        billStatusId: { enum: "", value: "0", name: "草稿" },
        orderMan: this.$store.state.user.userData.staffName,
        orderManId: this.$store.state.user.userData.id,
        new: true,
        detailList:[],
        guestId: '',
          _highlight: true,
      },
      page: {
        total: 0,
        size: 20,
        num: 1
      },
      tableData: [],
      query: {
        showPerson: 1
      }, //更多搜索信息
      Flaga: true,
      selectItemId:'',
    };
  },
  mounted() {
    this.gitlistValue();
  },
  computed: {
    queryall() {
      return this.$store.state.dataList.orederQueryList;
    },
    getRightType() {
      return this.$store.state.dataList.leftList;
    }
  },
  methods: {

    // 新增展示
    getAdd() {
      if (this.$parent.$parent.isAdd) {
        return this.$Message.error('请先保存数据');
      }
      this.selectItemId = "";
      for(let b of this.tableData){
          b._highlight = false
      }
      this.tableData.unshift(this.PtRow);
      this.$refs.currentRowTable.setCurrentRow(this.tableData[0])
      this.$parent.$parent.isAdd = false
      this.$parent.$parent.isNew=false
    },
    change(){
      this.Flaga = false
    },
    //获取表格数据
    async gitlistValue() {
      let data = {};
      data.startTime = this.queryTime[0] || "";
      data.endTime = this.queryTime[1] || "";
      data.billStatusId = this.orderType;
      let page = this.page.num - 1;
      let size = this.page.size;
      let res = await getLeftList(page, size, data);
      if (res.code === 0) {
        this.tableData = res.data.content;
        this.page.total = res.data.totalElements;
        this.$store.commit("setOneOrder", {});
        //筛选出当前操作的是第几条并选中
        for(let i in this.tableData){
            if(this.tableData[i].id==this.selectItemId){
                this.$refs.currentRowTable.setCurrentRow(this.tableData[i]);
                this.$emit("getOneOrder", this.tableData[i]);
                this.$store.commit("setOneOrder", this.tableData[i]);
                break;
            }
        }
        //如果没有保存过的数据取第一条选中
        if(!this.selectItemId){
          this.$refs.currentRowTable.setCurrentRow(this.tableData[0]);
          this.$emit("getOneOrder", this.tableData[0]);
          this.$store.commit("setOneOrder", this.tableData[0]);
        }
      }
    },
    //切换页面
    selectNum(val) {
      this.page.num = val;
      this.gitlistValue();
    },
    //切换页数
    selectPage(val) {
      this.page.num = 1;
      this.page.size = val;
      this.gitlistValue();
    },
    //点击获取当前信息
    clickOnesList(data) {
      if(data){
          this.selectItemId=data.row.id;
      }
      this.$parent.$parent.ispart=false;
      if(data.row == null) return;
      let currentRowTable = this.$refs["currentRowTable"];
      if(!this.Flaga && this.$parent.$parent.isAdd){
        this.$Modal.confirm({
          title: '您正在编辑单据，是否需要保存',
          onOk: () => {
            currentRowTable.clearCurrentRow();
            this.$emit('refresh','你好！');
            this.Flaga = false;
            this.$parent.$parent.isAdd = false
          },
          onCancel: () => {
            this.$parent.$parent.isAdd = false;
            this.$parent.$parent.isNew=true;
            this.tableData.splice(0, 1);
            currentRowTable.clearCurrentRow();
              for(let i in this.tableData){
                  if(this.tableData[i].id==this.selectItemId){
                      this.$refs.currentRowTable.setCurrentRow(this.tableData[i])
                      this.$emit("getOneOrder", this.tableData[i]);
                      this.$store.commit("setOneOrder", this.tableData[i]);
                      break;
                  }
              }
          },
        })
      }else {
          if(data.row.id){
              this.selectItemId=data.row.id;
          }
        this.$emit("getOneOrder", data.row);
        this.$store.commit("setOneOrder", data.row);
      }
    }
  },
  watch: {
    //监听时间
    queryTime: function(val, old) {
      this.page.num = 1;
      // this.page.size = 10;
      this.gitlistValue();
    },
    //监听状态
    orderType: function(val, old) {
      this.page.num = 1;
      // this.page.size = 10;
      this.gitlistValue();
    },
    //更多搜索
    queryall: {
      handler(v, ov) {
        v.showPerson = v.showPerson ? 1 : 0;
        this.page.num = 1;
        // this.page.size = 10;
        let page = this.page.num - 1;
        let size = this.page.size;
        getLeftList(page, size, v).then(res => {
          if (res.code === 0) {
            // res.data.content.map( item => {item.billStatusId = JSON.parse(item.billStatusId)})
            this.tableData = res.data.content;
            this.page.total = res.data.totalElements;
          }
        });
      },
      deep: true
    },
    //改变左侧list
    changeLeftList: {
      handler(v, ov) {
        this.page.num = 1;
        this.page.size = 10;
        this.gitlistValue();
      },
      deep: true
    },
    //右侧保存 提交
    getRightType: {
      handler(v, ov) {
        if (v.code === 0) {
          this.page.num = 1;
          // this.page.size = 10;
          this.gitlistValue();
        }
      },
      deep: true
    }
  }
};
</script>

<style scoped lang="less">
.orderList {
  line-height: 30px;
  padding-left: 10px;
  /*border-bottom: 1px solid #dcdee2;*/
  background-color: #f8f8f8;
}
.orderCenter {
  overflow: hidden;
  overflow-x: scroll;
}
</style>
